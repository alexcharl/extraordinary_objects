(()=>{"use strict";function e(e,t){return Math.floor(Math.random()*(t-e)+e)}function t(){const e=$("#mobileTester"),t=$("#tabletTester"),o=$("#gutter-tester");return{isMobile:e.is(":visible"),isTablet:t.is(":visible"),isDevice:e.is(":visible")||t.is(":visible"),isTouch:"ontouchstart"in window,gutter:o.is(":visible")}}function o(){const e=navigator.userAgent;let t="unknown";return e.indexOf("Chrome")>-1?t="chrome":e.indexOf("Safari")>-1?t="safari":e.indexOf("Firefox")>-1?t="firefox":(e.indexOf("MSIE")>-1||e.indexOf("Trident")>-1)&&(t="ie"),t}function i(){const e=window.gv={$window:$(window),$document:$(document),$html:$("html"),$body:$("body"),WIDTH:$(window).width(),HEIGHT:$(window).height(),deviceVariables:t(),browser:o(),$wrapper:$("#wrapper")};return console.log("initGlobal"),e}window.pumkin=window.pumkin||{},window.pumkin={getTransformValues:function(e,t){const o=e.css("transform").match(/-?[0-9\.]+/g),i=o[0],s={x:o[4]/i,y:o[5]/i};return"scale"===t?i:"translate"===t?s:"raw"===t?o:void 0},checkKey:function(e){return(e=e||window.event).keyCode},makePlaceholders:function(e,t){t=t||"active",$(e).each(function(){const e=$(this),o=e.data().placeholder;e.val(o),""===$.trim(e.val())&&e.val(o).removeClass(t),e.focus(function(){e.val()===o&&e.val("").addClass(t)}).blur(function(){""===$.trim(e.val())&&e.val(o).removeClass(t)})})},svgFallback:function(){$("img[src$='.svg']").each(function(){const e=$(this),t=e.attr("src").replace(".svg",".png");e.attr("src",t)})},normalizeBoxHeights:function(e){let t=0;e.each(function(){t=Math.max($(this).height(),t)}),e.each(function(){$(this).height(t)})},randomNum:e,autoFit:function(e,t,o,i,s,n,r){console.log("autoFit: "+t.length),o=o||0;const l=e.width()-o;t.removeAttr("style");const a=[];let c=0,d=[];t.each(function(){const e=$(this);c+=parseInt(e.css("width"))+o,c<=l?d.push(e):(a.push(d),d=new Array(e),c=parseInt(e.css("width"))+o),e.is(":last-child")&&s&&a.push(d)});const h=a.length;for(let e=0;e<h;e++){const t=a[e].length;let s=0;for(let i=0;i<t;i++)s+=parseInt(a[e][i].css("width"))+o;const n=(l-s)/t,c=s/t;let d=0;if(r){parseInt(a[0][0].css("width"))}for(let s=0;s<t;s++){const t=parseInt(a[e][s].css("width")),l=t/c,h=r?t+n:t+Math.floor(n*l);let m;if(0===e&&0===s){const o=parseInt(a[e][s].css("height"));m=i?Math.floor(h*(o/t)):o}a[e][s].css({width:h+"px",height:m+"px"}),d+=h+o}}},intelliLoad:function(e,t,o){o=o||!1,e.each(function(){const e=$(this),i=t||e.attr("src");if(i){const t=new Image;t.onload=function(){e.attr("src",i),o&&e.addClass("loaded")},t.onerror=function(){console.warn("Failed to load image:",i)},t.src=i}})},defineDeviceVariables:t,browserDetection:o},window.SITE=window.SITE||{},window.SITE.initGlobal=i;class s{constructor(){this.$sidePanel=$(".side-panel"),this.$sidePanelOpenBtn=$(".more"),this.$sidePanelCloseBtn=$(".close-side-panel")}init(){this.bindEvents()}bindEvents(){this.$sidePanelOpenBtn.on("click",()=>this.togglePanel()),this.$sidePanelCloseBtn.on("click",()=>this.closePanel())}togglePanel(){this.$sidePanel.hasClass("open")?this.$sidePanel.removeClass("open"):this.$sidePanel.addClass("open")}closePanel(){this.$sidePanel.removeClass("open")}}class n{constructor(){this.$overlay=$(".overlay"),this.$historyOpenBtn=$(".history"),this.$overlayCloseBtn=$(".close-overlay"),this.$historyObjects=$("#history-objects"),this.$historyWrapper=$(".history-wrapper .loading")}init(){this.bindEvents()}bindEvents(){this.$historyOpenBtn.on("click",()=>this.show()),this.$overlayCloseBtn.on("click",()=>this.hide())}show(){this.$overlay.hasClass("closed")&&(this.$overlay.removeClass("closed").addClass("open for-history"),this.renderHistory(),this.$overlay.fadeIn(500))}hide(){this.$historyObjects.text(""),this.$overlay.fadeOut(500,()=>{this.$overlay.removeClass("open for-history for-warning").addClass("closed")})}renderHistory(){this.$historyWrapper.addClass("loaded");const e=window.theHistory||[];let t=0;e&&0!==e.length?(this.$historyObjects.empty(),e.forEach(e=>{let o="";o+=`<a class="history-object hide-until-loaded" data-object-number="${e.objectNumber}" href="${e.vaCollectionsUrl}" title="View this item in the V&amp;A archive">`,o+=`<div class="history-object-image-holder" style="background-image: url('${e.imageUrl}');"></div>`,o+=`<img src="${e.imageUrl}" class="image-holder-for-loading" id="image-holder-${t}" >`,o+='<div class="history-object-info">',o+=`<p><strong>${e.title}</strong>, ${e.date}</p>`,o+=`<p>${e.artist}</p>`,o+="</div></a>",this.$historyObjects.append(o),$(`#image-holder-${t}`).on("load",function(){$(this).parent().addClass("loaded"),$(this).remove()}),t++})):this.$historyObjects.html('<p class="no-history">No objects viewed yet. Start exploring the V&A collection!</p>')}}class r{constructor(){this.$textContent=null,this.$objectCaption=null,this.$objectHeader=null,this.$downArrow=null,this.HEIGHT=null,this.isInitialized=!1}init(){this.defineVars(),this.bindEvents(),this.isInitialized=!0,console.log("ObjectDisplayComponent initialized")}defineVars(){const e=window.gv;this.HEIGHT=e.HEIGHT,this.$textContent=$(".text-content-column"),this.$objectCaption=$(".object-caption"),this.$objectHeader=$(".object-header"),this.$downArrow=$(".down-arrow")}bindEvents(){this.$downArrow.click(()=>{$("#object-description").velocity("scroll",{duration:700,offset:-100,easing:"ease-in-out",container:this.$textContent})}),this.$textContent.on("scroll",this.throttledScroll.bind(this))}onThrottledScroll(){const e=this.$textContent.scrollTop();e>.5*this.HEIGHT?this.$objectCaption.addClass("reveal"):this.$objectCaption.removeClass("reveal"),e>.5*this.HEIGHT?this.$objectHeader.addClass("hide"):this.$objectHeader.removeClass("hide")}throttledScroll(){this.onThrottledScroll()}updateHeight(e){this.HEIGHT=e}destroy(){this.isInitialized&&(this.$textContent.off("scroll",this.throttledScroll.bind(this)),this.$downArrow.off("click"),this.isInitialized=!1,console.log("ObjectDisplayComponent destroyed"))}}class l{constructor(){this.$overlay=null,this.$overlayCloseBtn=null,this.isInitialized=!1}init(){this.defineVars(),this.bindEvents(),this.isInitialized=!0,console.log("OverlayComponent initialized")}defineVars(){this.$overlay=$(".overlay"),this.$overlayCloseBtn=$(".close-overlay")}bindEvents(){this.$overlayCloseBtn.click(()=>{this.hideOverlay()}),this.$overlay.click(e=>{e.target===this.$overlay[0]&&this.hideOverlay()})}showErrorOverlay(){this.$overlay.removeClass("closed").addClass("open for-warning"),this.$overlay.fadeIn(500)}showOverlay(e=null,t=""){this.$overlay.removeClass("closed").addClass("open"),t&&this.$overlay.addClass(t),e&&this.$overlay.find(".overlay-content").html(e),this.$overlay.fadeIn(500)}hideOverlay(){this.$overlay.removeClass("open for-warning").addClass("closed"),this.$overlay.fadeOut(300)}isVisible(){return this.$overlay.hasClass("open")}destroy(){this.isInitialized&&(this.$overlayCloseBtn.off("click"),this.$overlay.off("click"),this.isInitialized=!1,console.log("OverlayComponent destroyed"))}}window.SITE=window.SITE||{};let a,c,d,h,m,u,g,p,f,v,y,w,b,C=null,I=null,T=null,j=null,k=null,S=null,x=null,E=null,H=[];let O,P,A,M;function V(){!function(){const e=window.gv;C=e.$window,I=e.$body,T=e.WIDTH,j=e.HEIGHT,c=e.$wrapper,k=e.deviceVariables.isMobile,S=e.deviceVariables.isTablet,x=e.deviceVariables.isDevice,E=e.deviceVariables.isTouch,a=e.browser,d=$(".text-content-column"),h=$(".object-caption"),m=$(".down-arrow"),u=$(".object-header"),g=$(".side-panel"),p=$(".more"),f=$(".close-side-panel"),v=$(".history"),y=$(".close-overlay"),w=$(".overlay"),b=$(".technical-info .text-content")}(),"undefined"!=typeof chrome&&void 0!==chrome.storage&&chrome.storage.local.get(["objectHistory"],function(e){e.objectHistory&&(H=e.objectHistory,window.theHistory=H,console.log("Loaded history from storage:",H.length,"items"))}),"undefined"!=typeof FastClick&&FastClick&&FastClick.attach(document.body),O=new s,O.init(),P=new n,P.init(),A=new r,A.init(),M=new l,M.init(),m.click(function(){$("#object-description").velocity("scroll",{duration:700,offset:-100,easing:"ease-in-out",container:d})}),$(".go-to-options").click(function(){chrome.runtime.openOptionsPage?chrome.runtime.openOptionsPage():window.open(chrome.runtime.getURL("/src/options/index.html"))}),N(),C.on("resize",N),C.on("resize",B),C.on("resize",U),z(),d.on("scroll",D),console.log("initMain")}function z(){const e=d.scrollTop();e>.5*j?h.addClass("reveal"):h.removeClass("reveal"),e>.5*j?u.addClass("hide"):u.removeClass("hide")}window.theHistory=H,window.maxHistoryItems=10;const D=function(){z()};function N(){T=C.width(),j=C.height(),A&&A.updateHeight(j)}function _(){}const B=$.throttle(250,function(){}),U=$.debounce(100,function(){});window.SITE.initMain=V,window.SITE.throwError=function(){M.showErrorOverlay()},window.SITE.onThrottledResize=_,window.SITE=window.SITE||{};const G=["Architecture","Asia","British Galleries","Ceramics","Childhood","Contemporary","Fashion","Jewellery","Furniture","Glass","Metalwork","Paintings","Drawings","Photography","Prints","Books","Sculpture","Textiles","Theatre"];let R,F,q=!1,L=0;function W(){F=R[e(0,R.length)],console.log("Chosen search term: "+F+" from "+R.length+" available terms")}function Y(){if(console.log("=== V&A API START FUNCTION CALLED ==="),console.log("looking for user settings"),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage&&(console.log("Testing background script communication..."),chrome.runtime.sendMessage({action:"test"},function(e){console.log("Background script test response:",e)})),"undefined"!=typeof chrome&&void 0!==chrome.storage)chrome.storage.sync.get({userSearchTerms:"",strictSearch:"fuzzy"},function(e){e.userSearchTerms.length>0?(console.log("using user search terms: "+e.userSearchTerms),R=e.userSearchTerms.replace(/ /g,"+").split(",")):(console.log("using default search terms: "+G),R=G),console.log("strictSearch setting = "+e.strictSearch),"strict"==e.strictSearch&&(q=!0);const t=R.join(", ");$("#search-terms").text(t),W(),J(null,F)});else{console.log("Running as standalone page, using default search terms: "+G),R=G;const e=R.join(", ");$("#search-terms").text(e),W(),J(null,F)}}function J(e,t,o,i,s,n,r,l){if(L<5){L++,e=void 0!==e?e:null,s=void 0!==s?s:"1",i=void 0!==i?i:"1",t=void 0!==t?t:null,n=void 0!==n?n:"1",r=void 0!==r?r:null,l=void 0!==l?l:"0";let a=0;if(null!=(o=void 0!==o?o:null)?a=1:null!=e&&(a=2),1==q){t=null}else{}console.log("strictSearch = "+q),console.log("expectResponse = "+a),console.log("Chosen term = "+t),console.log("offset = "+o),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage?(console.log("Sending message to background script..."),chrome.runtime.sendMessage({action:"makeVaRequest",params:{systemNumber:e,searchTerm:t,offset:o,limit:i,withImages:s,withDescription:n,after:r,random:l,hasImage:"1"}},function(e){console.log("Received response from background script:",e),e&&e.success?(console.log("API request successful"),K(e.data,a)):(console.log("API request failed:",e?e.error:"No response"),W(),J(null,F))})):(console.log("Running as standalone page - API requests will fail due to CORS"),SITE.throwError())}else console.log("maximum number of search attempts reached, try changing search terms"),SITE.throwError()}function K(t,o){if(console.log(t),0===o){if(t.records.length>0){const o=e(0,t.info.record_count-1);console.log("total results = "+t.info.record_count),console.log("randomOffset range: 0 to "+(t.info.record_count-1)),console.log("generated randomOffset = "+o),console.log("making query 2, with randomOffset of "+o),J(null,F,o)}else console.log("making a second request, no results found last time"),W(),J(null,F);return}if(1===o){const e=t.records.length;console.log("There are "+e+" objects available.");const o=t.records[0].systemNumber;return console.log("Selected object system number: "+o),void J(o)}if(!t.records||0===t.records.length)return console.log("No object found for system number, trying a different search term"),W(),void J(null,F);let i=t.records[0];console.log("Processing object data:",i);let s=i._primaryImageId;(!s||null===s||""===s)&&2!==o&&t.records.length>1&&(console.log("Object has no image, trying next object in search results"),i=t.records[1],s=i._primaryImageId,console.log("Next object image ID:",s));const n=i.objectType;let r=""!=i._primaryTitle?i._primaryTitle:i.objectType;const l=i._primaryDate,a=i.systemNumber,c=i._primaryMaker&&i._primaryMaker.name?i._primaryMaker.name:"",d=i.systemNumber;let h="";console.log("Extracted data - Title:",r,"Artist:",c,"System Number:",d,"Image ID:",s);let m="";if(i._primaryMaker&&i._primaryMaker.birthYear){const e=i._primaryMaker.birthYear,t=i._primaryMaker.deathYear;e&&t?m="("+e+" - "+t+")":e&&(m="(Born "+e+")")}let u="";s&&null!==s&&""!==s&&(u="https://framemark.vam.ac.uk/collections/"+s+"/full/1000,/0/default.jpg");const g="https://collections.vam.ac.uk/item/"+d+"/"+a;let p="";const f=i._primaryPlace,v=i.accessionNumber,y=i._currentLocation?i._currentLocation.displayName:"";r=r.replace(/\^/,""),r=r.replace(/\<i\>/g,""),r=r.replace(/\<\\i\>/g,""),r=r.replace(/\<b\>/g,""),r=r.replace(/\<\\b\>/g,"");const w="<strong>"+r+" "+l+"</strong> &mdash; "+c+" "+m,b=[];r&&r!==n&&b.push(r),l&&b.push("Dated "+l),f&&b.push("from "+f),c&&"Unknown"!==c&&b.push("by "+c),h=b.length>0?b.join(", ")+".":"A "+n+" from the V&A collection.",h=h.replace(/Object Type\n/g,""),h=h.replace(/People\n/g,""),h=h.replace(/Place\n/g,""),h=h.replace(/Places\n/g,""),h=h.replace(/Time\n/g,""),h=h.replace(/Design \& Designing\n/g,""),h=h.replace(/Design\n/g,""),h=h.replace(/Subject Depicted\n/g,""),h=h.replace(/Subjects Depicted\n/g,""),h=h.replace(/Materials \& Making\n/g,""),h=h.replace(/Collectors \& Owners\n/g,""),h=h.replace(/Ownership \& Use\n/g,""),h=h.replace(/Trading\n/g,""),h=h.replace(/Trade\n/g,""),h=h.replace(/Historical Associations\n/g,""),h=h.replace(/Other\n/g,""),h=h.replace(/\n\n\n/g,"\n\n"),h=h.replace(/\n/g,"<br>"),h=h.replace(/\<i\>/g,""),h=h.replace(/\<\\i\>/g,""),h=h.replace(/\<b\>/g,""),h=h.replace(/\<\\b\>/g,""),p=p.replace(/\<i\>/g,""),p=p.replace(/\<\\i\>/g,""),p=p.replace(/\<b\>/g,""),p=p.replace(/\<\\b\>/g,"");const C=void 0!==l&&null!=l?l:"";let I="https://www.pinterest.com/pin/create/button/";if(I+="?url="+g,I+="&media="+u,I+="&description="+r,""!=C&&(I+=" ("+f+", "+C+")"),I+=", V%26A Collection",r.length>42&&($("#title").addClass("reduced"),$("#piece-date").addClass("reduced")),$("#creator-name").text(c),$("#dates-alive").text(m),$("#title").html(r),""!=C&&$("#piece-date").text("("+C+")"),$("#place").html(f),u&&""!==u)$("#image").attr("src",u),$("#pinterest-button").attr("href",I);else{$(".object-image-wrapper").html('<div class="image-placeholder"><p>Image not available</p><p><small>This object may not have been photographed yet, or the image may be temporarily unavailable.</small></p></div>')}$("#page-link").attr("href",g),console.log("UI Updates - Setting title to:",r),console.log("UI Updates - Setting artist to:",c),console.log("UI Updates - Setting image to:",u);const T=h&&""!==h.trim()?h:"No description available for this object.";if($("#object-description").html("<p>"+T+"</p>"),$("#object-context").html("<p></p>"),$("#object-side-caption").html(w),""!=p?$("#physical-description").html(p):(console.log("hiding physical description"),$("#physical-description").hide(),$("#physical-description").prev("h4").hide()),""!=C?$("#tech-info-piece-date").text(C):($("#tech-info-piece-date").hide(),$("#tech-info-piece-date").prev("h4").hide()),""!=c?$("#tech-info-creator-name").text(c):($("#tech-info-creator-name").hide(),$("#tech-info-creator-name").prev("h4").hide()),$("#tech-info-materials").hide(),$("#tech-info-materials").prev("h4").hide(),""!=f?$("#tech-info-place").text(f):($("#tech-info-place").hide(),$("#tech-info-place").prev("h4").hide()),$("#dimensions").hide(),$("#dimensions").prev("h4").hide(),""!=y?$("#museum-location").text(y):($("#museum-location").hide(),$("#museum-location").prev("h4").hide()),""!=v?$("#museum-number").text(v):($("#museum-number").hide(),$("#museum-number").prev("h4").hide()),SITE.onThrottledResize(),$(".content-placeholder, .hide-until-loaded").addClass("loaded"),u&&""!==u?$("img.image-hide-until-loaded").on("load",function(){$(".image-hide-until-loaded, .hide-after-loaded").addClass("loaded"),$(this).removeClass("image-error")}).on("error",function(){console.log("Image failed to load:",u);$(this).closest(".object-image-wrapper").html('<div class="image-placeholder"><p>Image not available</p><p><small>This object may not have been photographed yet, or the image may be temporarily unavailable.</small></p></div>'),$(".image-hide-until-loaded, .hide-after-loaded").addClass("loaded")}):$(".image-hide-until-loaded, .hide-after-loaded").addClass("loaded"),0!==o&&1!==o){const e={objectNumber:d,vaCollectionsUrl:g,imageUrl:u,title:r,date:C,artist:c,systemNumber:d},t=window.theHistory||[];t.push(e),t.length>(window.maxHistoryItems||10)&&t.shift(),window.theHistory=t,"undefined"!=typeof chrome&&void 0!==chrome.storage&&chrome.storage.local.set({objectHistory:t},function(){console.log("History saved to storage:",t.length,"items")})}}window.SITE.start=Y,window.SITE.makeVaRequest=J,window.SITE.processResponse=K,window.SITE=window.SITE||{},$(document).ready(function(){console.log("=== V&A Chrome Extension Initializing ==="),i(),V(),Y(),console.log("=== V&A Chrome Extension Initialized ===")})})();