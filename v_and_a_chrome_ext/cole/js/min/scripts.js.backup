(()=>{"use strict";function e(e,o){return Math.floor(Math.random()*(o-e)+e)}function o(){const e=$("#mobileTester"),o=$("#tabletTester"),t=$("#gutter-tester");return{isMobile:e.is(":visible"),isTablet:o.is(":visible"),isDevice:e.is(":visible")||o.is(":visible"),isTouch:"ontouchstart"in window,gutter:t.is(":visible")}}function t(){const e=navigator.userAgent;let o="unknown";return e.indexOf("Chrome")>-1?o="chrome":e.indexOf("Safari")>-1?o="safari":e.indexOf("Firefox")>-1?o="firefox":(e.indexOf("MSIE")>-1||e.indexOf("Trident")>-1)&&(o="ie"),o}function n(){const e=window.gv={$window:$(window),$document:$(document),$html:$("html"),$body:$("body"),WIDTH:$(window).width(),HEIGHT:$(window).height(),deviceVariables:o(),browser:t(),$wrapper:$("#wrapper")};return console.log("initGlobal"),e}window.pumkin=window.pumkin||{},window.pumkin={getTransformValues:function(e,o){const t=e.css("transform").match(/-?[0-9\.]+/g),n=t[0],i={x:t[4]/n,y:t[5]/n};return"scale"===o?n:"translate"===o?i:"raw"===o?t:void 0},checkKey:function(e){return(e=e||window.event).keyCode},makePlaceholders:function(e,o){o=o||"active",$(e).each(function(){const e=$(this),t=e.data().placeholder;e.val(t),""===$.trim(e.val())&&e.val(t).removeClass(o),e.focus(function(){e.val()===t&&e.val("").addClass(o)}).blur(function(){""===$.trim(e.val())&&e.val(t).removeClass(o)})})},svgFallback:function(){$("img[src$='.svg']").each(function(){const e=$(this),o=e.attr("src").replace(".svg",".png");e.attr("src",o)})},normalizeBoxHeights:function(e){let o=0;e.each(function(){o=Math.max($(this).height(),o)}),e.each(function(){$(this).height(o)})},randomNum:e,autoFit:function(e,o,t,n,i,s,r){console.log("autoFit: "+o.length),t=t||0;const a=e.width()-t;o.removeAttr("style");const l=[];let c=0,d=[];o.each(function(){const e=$(this);c+=parseInt(e.css("width"))+t,c<=a?d.push(e):(l.push(d),d=new Array(e),c=parseInt(e.css("width"))+t),e.is(":last-child")&&i&&l.push(d)});const h=l.length;for(let e=0;e<h;e++){const o=l[e].length;let i=0;for(let n=0;n<o;n++)i+=parseInt(l[e][n].css("width"))+t;const s=(a-i)/o,c=i/o;let d=0;if(r){parseInt(l[0][0].css("width"))}for(let i=0;i<o;i++){const o=parseInt(l[e][i].css("width")),a=o/c,h=r?o+s:o+Math.floor(s*a);let m;if(0===e&&0===i){const t=parseInt(l[e][i].css("height"));m=n?Math.floor(h*(t/o)):t}l[e][i].css({width:h+"px",height:m+"px"}),d+=h+t}}},intelliLoad:function(e,o,t){t=t||!1,e.each(function(){const e=$(this),n=o||e.attr("src");if(n){const o=new Image;o.onload=function(){e.attr("src",n),t&&e.addClass("loaded")},o.onerror=function(){console.warn("Failed to load image:",n)},o.src=n}})},defineDeviceVariables:o,browserDetection:t},window.SITE=window.SITE||{},window.SITE.initGlobal=n,window.SITE=window.SITE||{};let i,s,r,a,l,c,d,h,m,u,g,p,f,w=null,b=null,v=null,y=null,I=null,T=null,C=null,S=null,k=[];function j(){!function(){const e=window.gv;w=e.$window,b=e.$body,v=e.WIDTH,y=e.HEIGHT,s=e.$wrapper,I=e.deviceVariables.isMobile,T=e.deviceVariables.isTablet,C=e.deviceVariables.isDevice,S=e.deviceVariables.isTouch,i=e.browser,r=$(".text-content-column"),a=$(".object-caption"),l=$(".down-arrow"),c=$(".object-header"),d=$(".side-panel"),h=$(".more"),m=$(".close-side-panel"),u=$(".history"),g=$(".close-overlay"),p=$(".overlay"),f=$(".technical-info .text-content")}(),"undefined"!=typeof chrome&&void 0!==chrome.storage&&chrome.storage.local.get(["objectHistory"],function(e){e.objectHistory&&(k=e.objectHistory,window.theHistory=k,console.log("Loaded history from storage:",k.length,"items"))}),"undefined"!=typeof FastClick&&FastClick&&FastClick.attach(document.body),h.click(function(){d.hasClass("open")?d.removeClass("open"):d.addClass("open")}),m.click(function(){d.removeClass("open")}),l.click(function(){$("#object-description").velocity("scroll",{duration:700,offset:-100,easing:"ease-in-out",container:r})}),u.click(function(){p.hasClass("closed")&&(p.removeClass("closed").addClass("open for-history"),x(),p.fadeIn(500))}),g.click(function(){p.fadeOut(500,function(){p.removeClass("open for-history for-warning").addClass("closed")})}),$(".go-to-options").click(function(){chrome.runtime.openOptionsPage?chrome.runtime.openOptionsPage():window.open(chrome.runtime.getURL("/src/options/index.html"))}),H(),w.on("resize",H),w.on("resize",D),w.on("resize",N),E(),r.on("scroll",M),console.log("initMain")}function x(){$(".history-wrapper .loading").addClass("loaded"),function(){let e=0;const o=window.theHistory||k||[];if(!o||0===o.length)return void $("#history-objects").html('<p class="no-history">No objects viewed yet. Start exploring the V&A collection!</p>');o.forEach(function(o){let t="";t+='<a class="history-object hide-until-loaded" data-object-number="'+o.objectNumber+'" href="'+o.vaCollectionsUrl+'"',t+='title="View this item in the V&amp;A archive">',t+='<div class="history-object-image-holder" ',t+="style=\"background-image: url('"+o.imageUrl+"');\">",t+="</div>",t+='<img src="'+o.imageUrl+'" class="image-holder-for-loading" id="image-holder-'+e+'" >',t+='<div class="history-object-info">',t+="<p><strong>"+o.title+"</strong>, "+o.date+"</p>",t+="<p>"+o.artist+"</p>",t+="</div>",t+="</a>",$("#history-objects").append(t),$("#image-holder-"+e).on("load",function(){$(this).parent().addClass("loaded"),$(this).remove()}),e++})}()}function E(){const e=r.scrollTop();e>.5*y?a.addClass("reveal"):a.removeClass("reveal"),e>.5*y?c.addClass("hide"):c.removeClass("hide")}window.theHistory=k,window.maxHistoryItems=10;const M=function(){E()};function H(){v=w.width(),y=w.height()}function A(){}const D=$.throttle(250,function(){}),N=$.debounce(100,function(){});window.SITE.initMain=j,window.SITE.throwError=function(){p.removeClass("closed").addClass("open for-warning"),p.fadeIn(500)},window.SITE.onThrottledResize=A,window.SITE.showHistory=x,window.SITE.hideHistory=function(){$("#history-objects").text("")},window.SITE=window.SITE||{};const O=["Architecture","Asia","British Galleries","Ceramics","Childhood","Contemporary","Fashion","Jewellery","Furniture","Glass","Metalwork","Paintings","Drawings","Photography","Prints","Books","Sculpture","Textiles","Theatre"];let _,V,P=!1,U=0;function R(){V=_[e(0,_.length)],console.log("Chosen search term: "+V+" from "+_.length+" available terms")}function F(){if(console.log("=== V&A API START FUNCTION CALLED ==="),console.log("looking for user settings"),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage&&(console.log("Testing background script communication..."),chrome.runtime.sendMessage({action:"test"},function(e){console.log("Background script test response:",e)})),"undefined"!=typeof chrome&&void 0!==chrome.storage)chrome.storage.sync.get({userSearchTerms:"",strictSearch:"fuzzy"},function(e){e.userSearchTerms.length>0?(console.log("using user search terms: "+e.userSearchTerms),_=e.userSearchTerms.replace(/ /g,"+").split(",")):(console.log("using default search terms: "+O),_=O),console.log("strictSearch setting = "+e.strictSearch),"strict"==e.strictSearch&&(P=!0);const o=_.join(", ");$("#search-terms").text(o),R(),z(null,V)});else{console.log("Running as standalone page, using default search terms: "+O),_=O;const e=_.join(", ");$("#search-terms").text(e),R(),z(null,V)}}function z(e,o,t,n,i,s,r,a){if(U<5){U++,e=void 0!==e?e:null,i=void 0!==i?i:"1",n=void 0!==n?n:"1",o=void 0!==o?o:null,s=void 0!==s?s:"1",r=void 0!==r?r:null,a=void 0!==a?a:"0";let l=0;if(null!=(t=void 0!==t?t:null)?l=1:null!=e&&(l=2),1==P){o=null}else{}console.log("strictSearch = "+P),console.log("expectResponse = "+l),console.log("Chosen term = "+o),console.log("offset = "+t),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage?(console.log("Sending message to background script..."),chrome.runtime.sendMessage({action:"makeVaRequest",params:{systemNumber:e,searchTerm:o,offset:t,limit:n,withImages:i,withDescription:s,after:r,random:a,hasImage:"1"}},function(e){console.log("Received response from background script:",e),e&&e.success?(console.log("API request successful"),q(e.data,l)):(console.log("API request failed:",e?e.error:"No response"),R(),z(null,V))})):(console.log("Running as standalone page - API requests will fail due to CORS"),SITE.throwError())}else console.log("maximum number of search attempts reached, try changing search terms"),SITE.throwError()}function q(o,t){if(console.log(o),0===t){if(o.records.length>0){const t=e(0,o.info.record_count-1);console.log("total results = "+o.info.record_count),console.log("randomOffset range: 0 to "+(o.info.record_count-1)),console.log("generated randomOffset = "+t),console.log("making query 2, with randomOffset of "+t),z(null,V,t)}else console.log("making a second request, no results found last time"),R(),z(null,V);return}if(1===t){const e=o.records.length;console.log("There are "+e+" objects available.");const t=o.records[0].systemNumber;return console.log("Selected object system number: "+t),void z(t)}if(!o.records||0===o.records.length)return console.log("No object found for system number, trying a different search term"),R(),void z(null,V);let n=o.records[0];console.log("Processing object data:",n);let i=n._primaryImageId;(!i||null===i||""===i)&&2!==t&&o.records.length>1&&(console.log("Object has no image, trying next object in search results"),n=o.records[1],i=n._primaryImageId,console.log("Next object image ID:",i));const s=n.objectType;let r=""!=n._primaryTitle?n._primaryTitle:n.objectType;const a=n._primaryDate,l=n.systemNumber,c=n._primaryMaker&&n._primaryMaker.name?n._primaryMaker.name:"",d=n.systemNumber;let h="";console.log("Extracted data - Title:",r,"Artist:",c,"System Number:",d,"Image ID:",i);let m="";if(n._primaryMaker&&n._primaryMaker.birthYear){const e=n._primaryMaker.birthYear,o=n._primaryMaker.deathYear;e&&o?m="("+e+" - "+o+")":e&&(m="(Born "+e+")")}let u="";i&&null!==i&&""!==i&&(u="https://framemark.vam.ac.uk/collections/"+i+"/full/1000,/0/default.jpg");const g="https://collections.vam.ac.uk/item/"+d+"/"+l;let p="";const f=n._primaryPlace,w=n.accessionNumber,b=n._currentLocation?n._currentLocation.displayName:"";r=r.replace(/\^/,""),r=r.replace(/\<i\>/g,""),r=r.replace(/\<\\i\>/g,""),r=r.replace(/\<b\>/g,""),r=r.replace(/\<\\b\>/g,"");const v="<strong>"+r+" "+a+"</strong> &mdash; "+c+" "+m,y=[];r&&r!==s&&y.push(r),a&&y.push("Dated "+a),f&&y.push("from "+f),c&&"Unknown"!==c&&y.push("by "+c),h=y.length>0?y.join(", ")+".":"A "+s+" from the V&A collection.",h=h.replace(/Object Type\n/g,""),h=h.replace(/People\n/g,""),h=h.replace(/Place\n/g,""),h=h.replace(/Places\n/g,""),h=h.replace(/Time\n/g,""),h=h.replace(/Design \& Designing\n/g,""),h=h.replace(/Design\n/g,""),h=h.replace(/Subject Depicted\n/g,""),h=h.replace(/Subjects Depicted\n/g,""),h=h.replace(/Materials \& Making\n/g,""),h=h.replace(/Collectors \& Owners\n/g,""),h=h.replace(/Ownership \& Use\n/g,""),h=h.replace(/Trading\n/g,""),h=h.replace(/Trade\n/g,""),h=h.replace(/Historical Associations\n/g,""),h=h.replace(/Other\n/g,""),h=h.replace(/\n\n\n/g,"\n\n"),h=h.replace(/\n/g,"<br>"),h=h.replace(/\<i\>/g,""),h=h.replace(/\<\\i\>/g,""),h=h.replace(/\<b\>/g,""),h=h.replace(/\<\\b\>/g,""),p=p.replace(/\<i\>/g,""),p=p.replace(/\<\\i\>/g,""),p=p.replace(/\<b\>/g,""),p=p.replace(/\<\\b\>/g,"");const I=void 0!==a&&null!=a?a:"";let T="https://www.pinterest.com/pin/create/button/";if(T+="?url="+g,T+="&media="+u,T+="&description="+r,""!=I&&(T+=" ("+f+", "+I+")"),T+=", V%26A Collection",r.length>42&&($("#title").addClass("reduced"),$("#piece-date").addClass("reduced")),$("#creator-name").text(c),$("#dates-alive").text(m),$("#title").html(r),""!=I&&$("#piece-date").text("("+I+")"),$("#place").html(f),u&&""!==u)$("#image").attr("src",u),$("#pinterest-button").attr("href",T);else{$(".object-image-wrapper").html('<div class="image-placeholder"><p>Image not available</p><p><small>This object may not have been photographed yet, or the image may be temporarily unavailable.</small></p></div>')}$("#page-link").attr("href",g),console.log("UI Updates - Setting title to:",r),console.log("UI Updates - Setting artist to:",c),console.log("UI Updates - Setting image to:",u);const C=h&&""!==h.trim()?h:"No description available for this object.";if($("#object-description").html("<p>"+C+"</p>"),$("#object-context").html("<p></p>"),$("#object-side-caption").html(v),""!=p?$("#physical-description").html(p):(console.log("hiding physical description"),$("#physical-description").hide(),$("#physical-description").prev("h4").hide()),""!=I?$("#tech-info-piece-date").text(I):($("#tech-info-piece-date").hide(),$("#tech-info-piece-date").prev("h4").hide()),""!=c?$("#tech-info-creator-name").text(c):($("#tech-info-creator-name").hide(),$("#tech-info-creator-name").prev("h4").hide()),$("#tech-info-materials").hide(),$("#tech-info-materials").prev("h4").hide(),""!=f?$("#tech-info-place").text(f):($("#tech-info-place").hide(),$("#tech-info-place").prev("h4").hide()),$("#dimensions").hide(),$("#dimensions").prev("h4").hide(),""!=b?$("#museum-location").text(b):($("#museum-location").hide(),$("#museum-location").prev("h4").hide()),""!=w?$("#museum-number").text(w):($("#museum-number").hide(),$("#museum-number").prev("h4").hide()),SITE.onThrottledResize(),$(".content-placeholder, .hide-until-loaded").addClass("loaded"),u&&""!==u?$("img.image-hide-until-loaded").on("load",function(){$(".image-hide-until-loaded, .hide-after-loaded").addClass("loaded"),$(this).removeClass("image-error")}).on("error",function(){console.log("Image failed to load:",u);$(this).closest(".object-image-wrapper").html('<div class="image-placeholder"><p>Image not available</p><p><small>This object may not have been photographed yet, or the image may be temporarily unavailable.</small></p></div>'),$(".image-hide-until-loaded, .hide-after-loaded").addClass("loaded")}):$(".image-hide-until-loaded, .hide-after-loaded").addClass("loaded"),0!==t&&1!==t){const e={objectNumber:d,vaCollectionsUrl:g,imageUrl:u,title:r,date:I,artist:c,systemNumber:d},o=window.theHistory||[];o.push(e),o.length>(window.maxHistoryItems||10)&&o.shift(),window.theHistory=o,"undefined"!=typeof chrome&&void 0!==chrome.storage&&chrome.storage.local.set({objectHistory:o},function(){console.log("History saved to storage:",o.length,"items")})}}window.SITE.start=F,window.SITE.makeVaRequest=z,window.SITE.processResponse=q,window.SITE=window.SITE||{},$(document).ready(function(){console.log("=== V&A Chrome Extension Initializing ==="),n(),j(),F(),console.log("=== V&A Chrome Extension Initialized ===")})})();